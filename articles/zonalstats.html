<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extract Zonal Statistics • mapme.vegetation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extract Zonal Statistics">
<meta property="og:description" content="mapme.vegetation">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.vegetation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/terminology.html">Terminology</a>
    </li>
    <li>
      <a href="../articles/workflow.html">Workflow</a>
    </li>
    <li>
      <a href="../articles/download.html">Download</a>
    </li>
    <li>
      <a href="../articles/cloudmasking.html">Cloud Masking</a>
    </li>
    <li>
      <a href="../articles/indices.html">Calculate Indices</a>
    </li>
    <li>
      <a href="../articles/trends.html">Calculate Trends</a>
    </li>
    <li>
      <a href="../articles/zonalstats.html">Extract zonal statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="zonalstats_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extract Zonal Statistics</h1>
            
            <h4 class="date">Last modified: 2021-10-18</h4>
      
      
      <div class="hidden name"><code>zonalstats.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapme.vegetation</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></code></pre></div>
<p>This vignette showcases different ways to extract zonal and pixelwise statistics from a time series processed with the <code>mapme.vegetation</code> package. We assume that we have processed S2 data to a dense time-series following vignette xx. Let’s read in the files and our AOI.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ndvi_files</span> <span class="op">=</span> <span class="va">s2_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/filled"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, <span class="st">".tif"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">bands</span> <span class="op">=</span> <span class="st">"NDVI"</span>
<span class="va">times</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">ndvi_files</span><span class="op">)</span>, <span class="op">-</span><span class="fl">14</span>, <span class="op">-</span><span class="fl">5</span><span class="op">)</span>

<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"exp_region_wgs.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">aoi_utm</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">32638</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi_utm</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">bbox</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">aoi_utm</span><span class="op">)</span></code></pre></div>
<p>As an example we will extract zonal statistics for the complete AOI. This function relies on <code>gdalcubes</code> which is why we need information of the spatio-temporal extent of the input files. These are the same as in the other vignettes. With this function we get information averaged over all pixels within a polygon for each time step. This information is useful for statistical analysis and might also be suitable for object based classification or regression problems which require information through the time axis. Specific metrics can be calculated. In case <code>zonalstat = "all"</code>, the count of pixels within the polygon, max, min, mean, median, prod, sd, sum, and var are returned. It is important to declare a column as the primary identification column with the argument <code>idcol</code>. Note that the returned object will be in a time-long format. That also means that the geometry column will be repeated. Because of this, the resulting object might be quite large. You can specify a filepath with the <code>outpath</code> argument to write the object to a GeoPackage (.gpkg).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">zs_aoi</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_zonalstats.html">extract_zonalstats</a></span><span class="op">(</span>aoi <span class="op">=</span> <span class="va">aoi_utm</span>, 
                            idcol <span class="op">=</span> <span class="st">"id"</span>, 
                            files <span class="op">=</span> <span class="va">ndvi_files</span>, 
                            times <span class="op">=</span> <span class="va">times</span>, 
                            bands <span class="op">=</span> <span class="va">bands</span>, 
                            bbox <span class="op">=</span> <span class="va">bbox</span>, 
                            zonalstat <span class="op">=</span> <span class="st">"all"</span>, 
                            after <span class="op">=</span> <span class="st">"2017-05-01"</span>, 
                            before <span class="op">=</span> <span class="st">"2017-07-31"</span>, 
                            srs <span class="op">=</span> <span class="st">"EPSG:32638"</span>, 
                            dx <span class="op">=</span> <span class="fl">200</span>, 
                            dy <span class="op">=</span> <span class="fl">200</span>, 
                            dt <span class="op">=</span> <span class="st">"P14D"</span>, 
                            aggregation <span class="op">=</span> <span class="st">"max"</span>, 
                            resampling <span class="op">=</span> <span class="st">"near"</span><span class="op">)</span>
<span class="co">#&gt; Registered S3 methods overwritten by 'stars':</span>
<span class="co">#&gt;   method             from</span>
<span class="co">#&gt;   st_bbox.SpatRaster sf  </span>
<span class="co">#&gt;   st_crs.SpatRaster  sf</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">zs_aoi</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 11 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 348194.9 ymin: 1056042 xmax: 362482.2 ymax: 1066928</span>
<span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 38N</span>
<span class="co">#&gt;         time NDVI_count  NDVI_max NDVI_mean NDVI_median   NDVI_min NDVI_prod</span>
<span class="co">#&gt; 1 2017-05-01       3960 0.2311295 0.1113241   0.1094208 0.01149299         0</span>
<span class="co">#&gt; 2 2017-05-15       3960 0.2550091 0.1403736   0.1374766 0.08732651         0</span>
<span class="co">#&gt; 3 2017-05-29       3960 0.2527738 0.1440155   0.1413268 0.08384857         0</span>
<span class="co">#&gt; 4 2017-06-12       3960 0.2771391 0.1437858   0.1408853 0.08632603         0</span>
<span class="co">#&gt; 5 2017-06-26       3960 0.2932819 0.1461920   0.1424436 0.09035429         0</span>
<span class="co">#&gt; 6 2017-07-10       3960 0.2951637 0.1515169   0.1462376 0.09173446         0</span>
<span class="co">#&gt;      NDVI_sd NDVI_sum     NDVI_var id                           geom</span>
<span class="co">#&gt; 1 0.02434982 440.8433 0.0005929139  1 POLYGON ((348194.9 1056042,...</span>
<span class="co">#&gt; 2 0.02166101 555.8793 0.0004691992  1 POLYGON ((348194.9 1056042,...</span>
<span class="co">#&gt; 3 0.02442111 570.3013 0.0005963905  1 POLYGON ((348194.9 1056042,...</span>
<span class="co">#&gt; 4 0.02448121 569.3919 0.0005993296  1 POLYGON ((348194.9 1056042,...</span>
<span class="co">#&gt; 5 0.02620776 578.9204 0.0006868465  1 POLYGON ((348194.9 1056042,...</span>
<span class="co">#&gt; 6 0.02761695 600.0071 0.0007626958  1 POLYGON ((348194.9 1056042,...</span></code></pre></div>
<p>On other occasions pixel-wise information for polygons might be of interest, e.g. when the goal of your analysis is the pixel-wise classification of a landscape. For this kind of extraction we rely on the <a href="https://rspatial.org/terra/">terra</a> package. For the resulting data.frame object to receive the right column names, however, it is important to hand over the band names and the associated time-stamp for each file.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ps_aoi</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_pixels.html">extract_pixels</a></span><span class="op">(</span>files <span class="op">=</span> <span class="va">ndvi_files</span>,
                        bands <span class="op">=</span> <span class="va">bands</span>,
                        times <span class="op">=</span> <span class="va">times</span>, 
                        aoi <span class="op">=</span> <span class="va">aoi_utm</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">ps_aoi</span><span class="op">)</span>
<span class="co">#&gt;   ID NDVI-2017-05-01 NDVI-2017-05-15 NDVI-2017-05-29 NDVI-2017-06-12</span>
<span class="co">#&gt; 1  1      0.10098172       0.1437648       0.1508505       0.1471979</span>
<span class="co">#&gt; 2  1      0.09259786       0.1310685       0.1391816       0.1403345</span>
<span class="co">#&gt; 3  1      0.08804486       0.1242767       0.1325152       0.1372536</span>
<span class="co">#&gt; 4  1      0.08691528       0.1218589       0.1303333       0.1359665</span>
<span class="co">#&gt; 5  1      0.08776132       0.1230615       0.1315388       0.1365081</span>
<span class="co">#&gt; 6  1      0.09056787       0.1301583       0.1377396       0.1404345</span>
<span class="co">#&gt;   NDVI-2017-06-26 NDVI-2017-07-10 NDVI-2017-07-24 id</span>
<span class="co">#&gt; 1       0.1449453       0.1495825       0.1599105  1</span>
<span class="co">#&gt; 2       0.1381166       0.1425987       0.1544822  1</span>
<span class="co">#&gt; 3       0.1353973       0.1394072       0.1510371  1</span>
<span class="co">#&gt; 4       0.1338123       0.1368362       0.1471831  1</span>
<span class="co">#&gt; 5       0.1342536       0.1372983       0.1475986  1</span>
<span class="co">#&gt; 6       0.1394512       0.1461845       0.1615133  1</span></code></pre></div>
<p>The resulting object is <strong>not</strong> an sf object. The spatially explicit information is list. However, the column <code>ID</code> indicates to to which feature in the <code>aoi</code> object the pixel information belongs in the order of rows of the input object. The data.frame object has a wide format. Each row represents a single pixel. The columns identify the band name as well as the time-stamp.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mapme-initiative.org/">MAPME-Initiative</a>, <a href="http://dariusgoergen.com/">Darius Görgen</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
