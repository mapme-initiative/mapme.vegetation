<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculate Indices • mapme.vegetation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculate Indices">
<meta property="og:description" content="mapme.vegetation">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.vegetation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9020</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/terminology.html">Terminology</a>
    </li>
    <li>
      <a href="../articles/workflow.html">Workflow</a>
    </li>
    <li>
      <a href="../articles/download.html">Download</a>
    </li>
    <li>
      <a href="../articles/cloudmasking.html">Cloud Masking</a>
    </li>
    <li>
      <a href="../articles/indices.html">Calculate Indices</a>
    </li>
    <li>
      <a href="../articles/trends.html">Calculate Trends</a>
    </li>
    <li>
      <a href="../articles/zonalstats.html">Extract zonal statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calculate Indices</h1>
            
            <h4 data-toc-skip class="date">Last modified:
2023-02-10</h4>
      
      
      <div class="hidden name"><code>indices.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mapme.vegetation</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; terra 1.7.3</span></span>
<span><span class="va">rundir</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"mapme.vegetation"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">rundir</span>, showWarnings <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="available-indices">Available Indices<a class="anchor" aria-label="anchor" href="#available-indices"></a>
</h2>
<p>In this vignette <code>mapme.vegetation</code> functionality to
derive a dense time series of vegetation indices is presented. The
package comes with a list of over 100 indices that can be calculated for
Sentinel 2. Issue the following command to inspect available
indices.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/check_indices.html">check_indices</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                       longname     name</span></span>
<span><span class="co">#&gt; 1           Aerosol free vegetation index 1600 AFRI1600</span></span>
<span><span class="co">#&gt; 2           Aerosol free vegetation index 2100 AFRI2100</span></span>
<span><span class="co">#&gt; 3                Anthocyanin reflectance index      ARI</span></span>
<span><span class="co">#&gt; 4                     Ashburn Vegetation Index      AVI</span></span>
<span><span class="co">#&gt; 5 Atmospherically Resistant Vegetation Index 2    ARVI2</span></span>
<span><span class="co">#&gt; 6     Blue-wide dynamic range vegetation index   BWDRVI</span></span>
<span><span class="co">#&gt;                                                 link</span></span>
<span><span class="co">#&gt; 1 http://www.indexdatabase.de/db/i-single.php?id=393</span></span>
<span><span class="co">#&gt; 2 http://www.indexdatabase.de/db/i-single.php?id=395</span></span>
<span><span class="co">#&gt; 3 http://www.indexdatabase.de/db/i-single.php?id=214</span></span>
<span><span class="co">#&gt; 4 http://www.indexdatabase.de/db/i-single.php?id=574</span></span>
<span><span class="co">#&gt; 5 http://www.indexdatabase.de/db/i-single.php?id=396</span></span>
<span><span class="co">#&gt; 6 http://www.indexdatabase.de/db/i-single.php?id=136</span></span>
<span><span class="co">#&gt;                                      s2_formula</span></span>
<span><span class="co">#&gt; 1 (band_8-0.66*(band_11)/(band_8+0.66*band_11))</span></span>
<span><span class="co">#&gt; 2  (band_8-0.5*(band_12)/(band_8+0.56*band_12))</span></span>
<span><span class="co">#&gt; 3                     (1)/(band_3)-(1)/(band_5)</span></span>
<span><span class="co">#&gt; 4                             2.0*band_9-band_4</span></span>
<span><span class="co">#&gt; 5  -0.18+1.17*((band_8-band_4)/(band_8+band_4))</span></span>
<span><span class="co">#&gt; 6       (0.1*band_8-band_2)/(0.1*band_8+band_2)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calculate-indices">Calculate Indices<a class="anchor" aria-label="anchor" href="#calculate-indices"></a>
</h2>
<p>In order to specify one or multiple indices refer to the short name
found in the column <code>name</code>. As a prerequisite for calculating
indices we assume that S2 data for a given spatio-temporal AOI has been
downloaded as explained in the vignette xx. Additionally, we assume that
the SCL has been enriched using the functionality explained in the
vignette xx. It is however possible to skip the cloud mask buffering and
proceed with the original SCL files. First, let’s read in the necessary
files and declare some arguments for the index calculation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s2_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/s2a"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, <span class="st">".tif"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">scl_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/scl"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, <span class="st">".tif"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"exp_region_wgs.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">aoi_utm</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="fl">32638</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bbox</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">aoi_utm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dx</span> <span class="op">=</span> <span class="fl">200</span> <span class="co"># desired outcome resolution in x direction</span></span>
<span><span class="va">dy</span> <span class="op">=</span> <span class="fl">200</span> <span class="co"># desired outcome resolution in y direction</span></span>
<span><span class="va">dt</span> <span class="op">=</span> <span class="st">"P14D"</span> <span class="co"># desired temporal resolution - here 1 month</span></span>
<span><span class="va">srs</span> <span class="op">=</span> <span class="st">"EPSG:32638"</span> <span class="co"># desired CRS of the outcome raster - bbox must be specified in that crs</span></span>
<span><span class="va">after</span> <span class="op">=</span> <span class="st">"2017-05-01"</span> <span class="co"># start date</span></span>
<span><span class="va">before</span> <span class="op">=</span> <span class="st">"2017-07-31"</span> <span class="co"># end date</span></span>
<span><span class="va">index</span> <span class="op">=</span> <span class="st">"NDVI"</span> <span class="co"># index to calculate, can specify multiple indices</span></span>
<span><span class="va">aggregation</span> <span class="op">=</span> <span class="st">"max"</span> <span class="co"># aggregation method for scene within the same time step</span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="st">"cubic"</span> <span class="co"># GDAL resampling method to match the outcome grid size</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">rundir</span>, <span class="st">"ndvi"</span><span class="op">)</span><span class="op">)</span> <span class="co"># create output directories</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">rundir</span>, <span class="st">"filled"</span><span class="op">)</span><span class="op">)</span> <span class="co"># create output directories</span></span>
<span><span class="va">label</span> <span class="op">=</span> <span class="st">"NDVI-"</span> <span class="co"># appended to filename</span></span>
<span><span class="va">mask_layer</span> <span class="op">=</span> <span class="st">"SCL"</span> <span class="co"># which band in the data cube is used as mask</span></span>
<span><span class="va">mask_values</span> <span class="op">=</span> <span class="fl">1</span> <span class="co"># which values to mask out</span></span>
<span><span class="va">mask_invert</span> <span class="op">=</span> <span class="cn">F</span> <span class="co"># logical if mask_values should be masked (TRUE) or kept (FALSE)</span></span></code></pre></div>
<p>With this prerequisites we can nearly start to calculate the NDVI.
Note, however, that we set the <code>mask_value = 1</code> to account
for our enriched cloud mask. That is why we should exchange the original
SCL files with our new SCL files.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s2_files</span> <span class="op">=</span> <span class="va">s2_files</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"SCL"</span>, <span class="va">s2_files</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">s2_files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">s2_files</span>, <span class="va">scl_files</span><span class="op">)</span></span></code></pre></div>
<p>Now we can start calculating the index. We will use a collection
definition which comes with the <code>mapme.vegetation</code> package to
let <code>gdalcubes</code> how to interpret the filenames from AWS. That
way, we are sure that the spatio-temporal extent of each single file is
rightly interpreted.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raw_ndvi</span> <span class="op">=</span> <span class="fu"><a href="../reference/index_cube.html">index_cube</a></span><span class="op">(</span>files <span class="op">=</span> <span class="va">s2_files</span>, </span>
<span>                      format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sentinel2_l2a_cog.json"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span>, </span>
<span>                      dx <span class="op">=</span> <span class="va">dx</span>, </span>
<span>                      dy <span class="op">=</span> <span class="va">dy</span>, </span>
<span>                      dt <span class="op">=</span> <span class="va">dt</span>, </span>
<span>                      srs <span class="op">=</span> <span class="va">srs</span>, </span>
<span>                      bbox <span class="op">=</span> <span class="va">bbox</span>, </span>
<span>                      after <span class="op">=</span> <span class="va">after</span>, </span>
<span>                      before <span class="op">=</span> <span class="va">before</span>, </span>
<span>                      aggregation <span class="op">=</span> <span class="va">aggregation</span>, </span>
<span>                      resampling <span class="op">=</span> <span class="va">resampling</span>, </span>
<span>                      index <span class="op">=</span> <span class="va">index</span>, </span>
<span>                      label <span class="op">=</span> <span class="va">label</span>, </span>
<span>                      outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">rundir</span>, <span class="st">"ndvi"</span><span class="op">)</span>, </span>
<span>                      overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                      mask_layer <span class="op">=</span> <span class="va">mask_layer</span>, </span>
<span>                      mask_values <span class="op">=</span> <span class="va">mask_values</span>,</span>
<span>                      mask_invert <span class="op">=</span> <span class="va">mask_invert</span>,</span>
<span>                      creation_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"COMPRESS"</span> <span class="op">=</span> <span class="st">"DEFLATE"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Current cube view is:</span></span>
<span><span class="co">#&gt; A data cube view object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dimensions:</span></span>
<span><span class="co">#&gt;                low             high count pixel_size</span></span>
<span><span class="co">#&gt; t       2017-05-01       2017-08-06     7       P14D</span></span>
<span><span class="co">#&gt; y  1055984.8569279  1066984.8569279    55        200</span></span>
<span><span class="co">#&gt; x 348138.569534966 362538.569534966    72        200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SRS: "EPSG:32638"</span></span>
<span><span class="co">#&gt; Temporal aggregation method: "max"</span></span>
<span><span class="co">#&gt; Spatial resampling method: "cubic"</span></span></code></pre></div>
<p>Let’s inspect the returned output. It is a list with three objects.
The first object is called <code>files</code> and contains the path to
the files. The second object is called <code>band_order</code> and
indicates the names and order of the bands in the output files. This can
be very important when multiple indices are calculated at once because
<code>gdalcubes</code> will return the bands in alphabetical order. The
last object is called <code>time</code> and indicates the timestamp for
each of the output files. Together this information can be used for
subsequent processing.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">raw_ndvi</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ files     : chr [1:7] "/tmp/RtmpCwnIDw/mapme.vegetation/ndvi/NDVI-2017-05-01.tif" "/tmp/RtmpCwnIDw/mapme.vegetation/ndvi/NDVI-2017-05-15.tif" "/tmp/RtmpCwnIDw/mapme.vegetation/ndvi/NDVI-2017-05-29.tif" "/tmp/RtmpCwnIDw/mapme.vegetation/ndvi/NDVI-2017-06-12.tif" ...</span></span>
<span><span class="co">#&gt;  $ band_order: chr "NDVI"</span></span>
<span><span class="co">#&gt;  $ time      : chr [1:7] "2017-05-01" "2017-05-15" "2017-05-29" "2017-06-12" ...</span></span></code></pre></div>
<p>Let’s visualize the NDVI raster files.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndvi_ras</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">raw_ndvi</span><span class="op">$</span><span class="va">files</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ndvi_ras</span><span class="op">)</span></span></code></pre></div>
<p><img src="indices_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>We see that we have some missing values during the first 14 day
period of May as well as more extensive missing values for the period
starting of May, 29th. Note that in the original resolution it is likely
that there are more missing values. In order to be able to ship the
example data sets with the package, the spatial resolution has been
resampled to 100 meters, which is a reduction in spatial resolution of
factor 10 for the band 4 and 8 that are used for the NDVI calculation.
However, due to cloud cover, missing observations are actually quite
frequent. The <code>mapme.vegetation</code> package offers functionality
for to apply interpolation of missing values and smoothing of the
resulting time series.</p>
</div>
<div class="section level2">
<h2 id="smoothing-a-time-series">Smoothing a Time Series<a class="anchor" aria-label="anchor" href="#smoothing-a-time-series"></a>
</h2>
<p>The default functionality is quite basic, applying linear
interpolation and applying a Savitzkiy-Golay filter. In case you need a
more sophisticated gap-filling strategy you can define your own
function. The function receives the time series of each pixel and is
expected to return the same number of pixels. Let’s consider the
smoothing with the basic approach. We will set the chunking option to
simultaneously process all 7 time-steps of our spatio-temporal extent.
This is important so that the complete time series is available.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">fill_ndvi</span> <span class="op">=</span> <span class="fu"><a href="../reference/smooth_cube.html">smooth_cube</a></span><span class="op">(</span>files <span class="op">=</span> <span class="va">raw_ndvi</span><span class="op">$</span><span class="va">files</span>,</span>
<span>                        bands <span class="op">=</span> <span class="va">raw_ndvi</span><span class="op">$</span><span class="va">band_order</span>, </span>
<span>                        times <span class="op">=</span> <span class="va">raw_ndvi</span><span class="op">$</span><span class="va">time</span>,</span>
<span>                        dx <span class="op">=</span> <span class="va">dx</span>, </span>
<span>                        dy <span class="op">=</span> <span class="va">dy</span>, </span>
<span>                        dt <span class="op">=</span> <span class="va">dt</span>, </span>
<span>                        srs <span class="op">=</span> <span class="va">srs</span>, </span>
<span>                        after <span class="op">=</span> <span class="va">after</span>, </span>
<span>                        before <span class="op">=</span> <span class="va">before</span>, </span>
<span>                        bbox <span class="op">=</span> <span class="va">bbox</span>, </span>
<span>                        aggregation <span class="op">=</span> <span class="va">aggregation</span>, </span>
<span>                        resampling <span class="op">=</span> <span class="va">resampling</span>, </span>
<span>                        outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">rundir</span>, <span class="st">"filled"</span><span class="op">)</span>, </span>
<span>                        label <span class="op">=</span> <span class="va">label</span>,</span>
<span>                        overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                        chunking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>,<span class="fl">100</span>,<span class="fl">100</span><span class="op">)</span>,</span>
<span>                        creation_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"COMPRESS"</span> <span class="op">=</span> <span class="st">"DEFLATE"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Current cube view is:</span></span>
<span><span class="co">#&gt; A data cube view object</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dimensions:</span></span>
<span><span class="co">#&gt;                low             high count pixel_size</span></span>
<span><span class="co">#&gt; t       2017-05-01       2017-08-06     7       P14D</span></span>
<span><span class="co">#&gt; y  1055984.8569279  1066984.8569279    55        200</span></span>
<span><span class="co">#&gt; x 348138.569534966 362538.569534966    72        200</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SRS: "EPSG:32638"</span></span>
<span><span class="co">#&gt; Temporal aggregation method: "max"</span></span>
<span><span class="co">#&gt; Spatial resampling method: "cubic"</span></span>
<span><span class="co">#&gt; No smoothing function specified.</span></span>
<span><span class="co">#&gt; Using Linear Interpolation and Savitzkiy-Golay-Filter with standard parameters.</span></span></code></pre></div>
<p>Let’s visualize the resulting gap filled and smoothed raster files.
We see that the missing values have been filled. Whether or not the
default smoothing function is suitable for your use case is a question
you have to answer for yourself. In the example section of
<code><a href="../reference/smooth_cube.html">mapme.vegetation::smooth_cube</a></code> you will find the default.
You can exchange that function by specifying a custom function with the
<code>smoothing_function</code> argument.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndvi_ras2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">fill_ndvi</span><span class="op">$</span><span class="va">files</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ndvi_ras2</span><span class="op">)</span></span></code></pre></div>
<p><img src="indices_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://dariusgoergen.com/" class="external-link">Darius Görgen</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
