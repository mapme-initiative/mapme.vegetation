<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>03 - Zonal Statistics • mapme.vegetation</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03 - Zonal Statistics">
<meta property="og:description" content="mapme.vegetation">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.vegetation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/E01-download.html">01 - Download</a>
    </li>
    <li>
      <a href="../articles/E02-calcIndices.html">02 - Calculation of Indices</a>
    </li>
    <li>
      <a href="../articles/E03-zonalstats.html">03 - Zonal Statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mapme-initiative/mapme.vegetation">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="E03-zonalstats_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>03 - Zonal Statistics</h1>
            
      
      
      <div class="hidden name"><code>E03-zonalstats.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapme.vegetation</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://rgdal.r-forge.r-project.org">rgdal</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: sp</span>
<span class="co">#&gt; rgdal: version: 1.5-23, (SVN revision 1121)</span>
<span class="co">#&gt; Geospatial Data Abstraction Library extensions to R successfully loaded</span>
<span class="co">#&gt; Loaded GDAL runtime: GDAL 3.0.4, released 2020/01/28</span>
<span class="co">#&gt; Path to GDAL shared files: /usr/share/gdal</span>
<span class="co">#&gt; GDAL binary built with GEOS: TRUE </span>
<span class="co">#&gt; Loaded PROJ runtime: Rel. 6.3.1, February 10th, 2020, [PJ_VERSION: 631]</span>
<span class="co">#&gt; Path to PROJ shared files: /usr/share/proj</span>
<span class="co">#&gt; Linking to sp version:1.4-5</span>
<span class="co">#&gt; To mute warnings of possible GDAL/OSR exportToProj4() degradation,</span>
<span class="co">#&gt; use options("rgdal_show_exportToProj4_warnings"="none") before loading rgdal.</span></code></pre></div>
<p>This article explains how we can extract a number of zonal statistics for pre-processed vegetation indices as explained in the article on the <a href="E02-calcIndices.html">calculation of indices</a>. We assume here that we calculated yearly NDVI raster files found in the current directory and we are extracting zonal statistics for polygons found in an sf object. Make sure that the <code>sf</code> object is in the same CRS as the raster files. We add an ID column to the object so to make sure we can link the resulting data to the original data. This is because any additional attributes will be dropped when calling the zonal statistics function.</p>
<p>The code for the extraction looks like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aoi</span> <span class="op">=</span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"testregion.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.vegetation"</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="st">"EPSG:3857"</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span>
<span class="va">rasterfiles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"."</span>, pattern <span class="op">=</span> <span class="st">"NDVI"</span><span class="op">)</span>

<span class="va">stats</span> <span class="op">=</span> <span class="fu">calcZS</span><span class="op">(</span>aoi <span class="op">=</span> <span class="va">aoi</span>, 
               idcol <span class="op">=</span> <span class="st">"id"</span>, 
               rasterfiles <span class="op">=</span> <span class="va">rasterfiles</span>, 
               dates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2016-12-31"</span>, <span class="st">"2017-12-31"</span>, <span class="st">"2018-12-31"</span>, <span class="st">"2019-12-31"</span><span class="op">)</span>, 
               band_name <span class="op">=</span> <span class="st">"NDVI"</span>,
               zonalstat <span class="op">=</span> <span class="st">"all"</span>,
               epsg <span class="op">=</span> <span class="st">"EPSG:3857"</span>,
               dx <span class="op">=</span> <span class="fl">20</span>,
               dy <span class="op">=</span> <span class="fl">20</span>,
               dt <span class="op">=</span> <span class="st">"P1Y"</span>,
               aggregation <span class="op">=</span> <span class="st">"median"</span>,
               resampling <span class="op">=</span> <span class="st">"bilinear"</span>,
               threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span><span class="va">stats</span>, dsn <span class="op">=</span> <span class="st">"./test.gpkg"</span><span class="op">)</span> <span class="co"># we have to manually write the file to disk</span></code></pre></div>
<p>As you can see, this time we specified the timestemps for each individual file directly. This is because gdalcubes has no other way to extract the time information from the processed NDVI files. We provide a band name which later will be included in the resulting <code>sf</code> object containing the zonal statistics. We also told the function to calculate all available statistics which are <code>min</code>, <code>max</code>, <code>mean</code>, <code>median</code>, <code>count</code>, <code>sum</code>, <code>prod</code>, <code>var</code>, and<code>sd</code>. But we also could have chosen any combination of these statistics. Because internally another data cube is created for the extraction, we have to specify its spatio-temporal properties once again (see the article on <a href="E02-calcIndices.html">index calculation</a> for more information).</p>
<p>The resulting object will be a sf object in long format. For each timestep all calculated statistics as well as the id column and the geometry will be repeated. Thus, when we calculate zonal statistics for 100 polygons over four timesteps, our resulting object will have 400 rows.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stats</span>
<span class="co">#&gt; Simple feature collection with 400 features and 11 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 306954.6 ymin: 3790785 xmax: 334562.1 ymax: 3827301</span>
<span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 43N</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;          time  NDVI_min  NDVI_max NDVI_mean NDVI_median NDVI_count  NDVI_sum</span>
<span class="co">#&gt; 1  2016-01-01 0.4355229 0.6571785 0.5502564   0.5589135        166  91.34256</span>
<span class="co">#&gt; 2  2016-01-01 0.4293436 0.5899788 0.5234075   0.5246399        111  58.09823</span>
<span class="co">#&gt; 3  2016-01-01 0.3942136 0.6269532 0.5038963   0.5056205         99  49.88573</span>
<span class="co">#&gt; 4  2016-01-01 0.3211738 0.5917581 0.4303972   0.4293475        473 203.57787</span>
<span class="co">#&gt; 5  2016-01-01 0.3383670 0.6607091 0.4767068   0.4644651        250 119.17671</span>
<span class="co">#&gt; 6  2016-01-01 0.3152293 0.7114302 0.4884458   0.4317801        104  50.79837</span>
<span class="co">#&gt; 7  2016-01-01 0.3586258 0.7313216 0.5448998   0.5446203        185 100.80645</span>
<span class="co">#&gt; 8  2016-01-01 0.3648068 0.5720104 0.4585591   0.4536167         92  42.18744</span>
<span class="co">#&gt; 9  2016-01-01 0.4001360 0.5876827 0.4932565   0.4888746         55  27.12910</span>
<span class="co">#&gt; 10 2016-01-01 0.4428478 0.6970429 0.5810687   0.5895201        251 145.84824</span>
<span class="co">#&gt;        NDVI_prod     NDVI_var    NDVI_sd id                           geom</span>
<span class="co">#&gt; 1   5.319580e-44 0.0016889196 0.04109647  1 MULTIPOLYGON (((326906.8 38...</span>
<span class="co">#&gt; 2   5.212332e-32 0.0008225624 0.02868035  2 MULTIPOLYGON (((332157.4 38...</span>
<span class="co">#&gt; 3   2.272505e-30 0.0020414432 0.04518233  3 MULTIPOLYGON (((329098 3814...</span>
<span class="co">#&gt; 4  4.511016e-175 0.0021132809 0.04597044  4 MULTIPOLYGON (((327116.8 38...</span>
<span class="co">#&gt; 5   2.858841e-82 0.0046948655 0.06851909  5 MULTIPOLYGON (((312179.5 38...</span>
<span class="co">#&gt; 6   1.844478e-34 0.0148216925 0.12174437  6 MULTIPOLYGON (((311942.5 38...</span>
<span class="co">#&gt; 7   2.034298e-50 0.0064935848 0.08058278  7 MULTIPOLYGON (((312188.3 38...</span>
<span class="co">#&gt; 8   4.968785e-32 0.0016538737 0.04066785  8 MULTIPOLYGON (((317683.1 38...</span>
<span class="co">#&gt; 9   1.031492e-17 0.0021561437 0.04643429  9 MULTIPOLYGON (((321892 3819...</span>
<span class="co">#&gt; 10  2.024260e-60 0.0030694922 0.05540300 10 MULTIPOLYGON (((308587.3 38...</span></code></pre></div>
<p>To do some basic analysis to compare different timesteps we are going to use a simple ggplot2 boxplot and we are reshaping our data to a truly long format beforehand.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'tidyr'</span>
<span class="co">#&gt; The following object is masked from 'package:magrittr':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     extract</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">time</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="va">stat</span>, <span class="va">value</span>, <span class="op">-</span><span class="va">time</span>, <span class="op">-</span><span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="va">stat</span>, <span class="st">"NDVI_"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">stat</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"min"</span>, <span class="st">"max"</span>, <span class="st">"median"</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, group<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">value</span>, fill<span class="op">=</span><span class="va">time</span><span class="op">)</span>, notch <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">stat</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="E03-zonalstats_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mapme-initiative.org/">MAPME-Initiative</a>, <a href="http://dariusgoergen.com/">Darius Görgen</a>, <a href="https://maptailor.net/">Fabian Löw</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
